---
title: "MA40198: Applied Statistical Inference"
author: "Candidates: 07604, 07614, 07615"
date: "`r format(Sys.time(), '%d %B %Y')`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Carcinogenesis Study on Rats

### Abstract
* Brief outline of: the problem; what you have done; and your conclusions. 
* Try not to use symbols/numbers 
* concise
* does the drug treatment work???????? Once found out, add this into abstract

Following a drug trial that was carried out on 150 rats, this study seeks to achieve an answer as to whether the method of cancer treatment is effective or not. 

Under the conditions of this study, there was very little to no evidence suggesting that the treatment used was a preventer of cancer within the observed population of rats.

### Introduction

* This should describe the general context and background, including a general description of what data are available, the manner in which they were collected. 
* Talk about aims of the investigation 
* Indicate the methods used
* Expanded version of the abstract
* Needs editing pls

The recorded data includes the variables: __Litter__- comprised of three rats pertaining to fifty different litters, __Treatment Indicator__- when $rx=1$ indicates the treatment was carried out on the rat and where $rx=0$ indicates the rat received the control/placebo only, __Time__- the follow up time, in weeks, to the appearance of a tumor, __Status__- status$=1$ describes that the presence of a tumor and status$=0$ implies the rat died before the presence of a tumor.

The drug trial was carried out on solely female rats in a controlled environment and saw one in three of the rats per litter being treated for cancer whilst the other two received a placebo "treatment" only. Following the treatment, the rats were detained and observed. If a tumor appeared on a rat or if the rat died, the occurance was recorded at the specific time in weeks, indicating which of the two outcomes occurred. This drug trial was carried out with the motivation to discover whether or not the method of cancer treatment used was effective or not.

Using Maximum Likelihood Estimation, this study is comprised of two main approaches of statistical analyses: frequentist estimation procedures and Bayesian estimation procedures. Using both the Bayesian and Frequentist approach, probability models for the follow up time and the survival function have been distributed using the Weibull function. A Frequentist approach was also taken whilst constructing a probability model for the data, using a log-logistic distribution. 

### Methods

* Use fairly detailed explanation of methods incl. any theory necessary
* __The reader should be able to repeat the study on the basis of the report__

* Could split the methods section into 
+ a preliminary analysis, using graphical methods/looking at simple descriptive methods if needed??? 
  + then a full scale analysis
* and then second section (Maybe into two subsections)
+ a description, explanation or development of the methodology used (this should be the most technical part of the report. It should describe detailed precise mathematical tools & techniques used)
+ the actual analysis.
* Include the graphs to show how we obtained the starting points maybe as 3 in a row. i.e. par(mfrow=c(1,2))
* The code for the functions

###preliminary analysis (first section) / EDA

* Maybe we could include separations of the data i.e. look at specifically how many had tumors etc etc

###detailed explanation of methods (Second section)
* Include Weibull, loglik, weibull w/ random effects-- marginal neg loglik on laplace &joint log density

Upon the first approach to the MLE problem, the dependent variable time described by $T_i$, has been taken to follow a Weibull distribution as we cannot assume that the data does not complies with the assumptions of normality. The distribution is as below.
$$ T_i \sim \mbox{Weibull}(\mbox{shape} = \frac{1}{\sigma}, \mbox{scale}=\exp(\eta_i)), \ \ \ \ \ \ \ \ \eta_i=\beta_0 + \beta_1 x_i $$
where
$$x_i=\left\{
\begin{array}{cl}
1 & \mbox{rat $i$ received treatment} \\
0 & \mbox{rat $i$ received control}\\
\end{array}
\right.$$ 
It can be seen from the above that the shape parameter in the model takes the form of $\frac{1}{\sigma}$ whilst the scale parameter is proportional to $\exp(\beta_0 + \beta_1 x_i)$. Censored observations, where the Treatment Indicator, $rx=0$, implied that the rat received only the control, are described by the survival function of a Weibull distribution given as follows.
$$ S(t|\mbox{a,b})= \exp\bigg(-\bigg( \frac{t}{b}\bigg)^a\bigg), \ \ \ \ \ \ \ \ t> 0 $$ 
The maximum likelihood estimate calculates an estimation of the population parameters such that the likelihood of obtaining the observed data is maximised. The vector of parameters that are to be estimated can be expressed as $\boldsymbol{\theta}^T=( \beta_0, \beta_1, \log(\sigma))$.

Given all observations $t_i$ are independent of one another, which we can assume to be true, the likelihood of the whole sample $T_i$ is the product of the individual likelihoods over all observations $t_i$. Where $L$ is the likelihood, it can be defined as follows.

$$ L=L_1 \times L_2 \times ... \times L_N = \prod^N_{i=1}{L_i} = P(y_1| \boldsymbol{\hat{\theta}}) \times P(y_2| \boldsymbol{\hat{\theta}}) \times ... \times P(y_N| \boldsymbol{\hat{\theta}}) = \prod^N_{i=1} P(y_i|\boldsymbol{\hat{\theta}} ) $$
It is true that the likelihood will always be positive and since the $\log$ function is a non decreasing function, if we transform the likelihood by taking the $\log$ of it, it's maxima will remain in the same position. When working with $\log$ it is more versatile as the sum of the log of the likelihood can be taken.

A function to describe the likelihood of the parameters $\boldsymbol{\theta}$ is defined in $R$ as below.


```{#numCode .R .numberLines}
nll.weibull <- function (theta) {
  #create subset of data since for the purposes of calculating the optimal theta since 
  #when status = 0, the survival function does not depend on theta. Need to optimise this 
  #function using optim.
  t1 <- rats[which(rats$status==1),,]$time
  rx1 <- rats[which(rats$status==1),,]$rx
  t0 <- rats[which(rats$status==0),,]$time
  rx0 <- rats[which(rats$status==0),,]$rx
  #compute the negative log likelihood
  k <- 1/exp(theta[3]) #shape 
  lambda <- exp(theta[1] + theta[2]*rx0) #scale with censoring
  loglik1 <- -sum(dweibull(t1, shape=1/exp(theta[3]), scale=exp(theta[1] + theta[2]*rx1), log=TRUE))
  loglik2 <- sum((t0/lambda)^k)
  loglik <- loglik1 + loglik2
  loglik
}
```


Initially, the function describing the negative log likelihood that seeks to be maximised has been defined as \texttt{nll.weibull}. This function includes subsetted data, so that the optimal $\boldsymbol{\theta}$ can be calculated. The use of subsetting is due to the fact that the survival function $S(t| \mbox{a,b})$ does not depend on $\boldsymbol{\theta}$ when the rats died prior to appearance of a tumor. These subsets are defined in lines 5-8 in the $R$ code above. Variable $\boldsymbol{t_0}$ defines a vector of the treatment indicator with respect to only the rats that did not die before the appearance of a tumor, $\boldsymbol{rx_1}$ defines a vector the treatment indicator with respect to only the rats that did not die before the appearance of a tumor, $\boldsymbol{t_1}$ defines a vector of the treatment indicator with respect to only the rats that died before the appearance of a tumor and lastly, $\boldsymbol{rx_0}$ defines a vector of the treatment indicator with respect to only the rats that died.

In order to compute the log likelihood for the censored observations, the shape and scale parameters of the survival function have been define as below. Given that the third element in $\boldsymbol{\theta}$ is proportional to $\log(\sigma)$, the exponent of $\sigma$ has been taken.
$$ \mbox{Shape}=\frac{1}{\exp(\sigma)}, \ \ \ \ \ \mbox{Scale} = \exp(\beta_0 + \beta_1rx_0) $$
The scale is altered by $rx_0$, since we are considering the treatment indicator based on only censored observations. The shape can be referred to as $k$ whilst the scale can be referred to as $\lambda$. 

Since the method of finding the MLE has utilised the $\mbox{optim}$ function in $R$, the negative log likelihoods are computed, as $\mbox{optim}$ optimises the given function and seeks the minimum value. The likelihood for censored observations has been defined below and can be seen in the $R$ code line 13.

$$ (L) _{rx=0}= - \sum -\log\bigg(\exp\bigg(-\bigg(\frac{t_0}{\lambda}\bigg)^k\bigg) \\
=\sum \bigg(\frac{t_0}{\lambda}\bigg)^k, \ \ \ \ \ \ \ \ t_0 > 0 $$ 

In order to compute the likelihood of the observations in which the appearance of a tumor occured, the shape and scale parameters were passed to the \texttt{dweibull} function built in to $R$. The shape and scale parameters for this probability model are defined below.

$$ \mbox{shape}= \frac{1}{\exp(\sigma)}, \ \ \ \ \ \ \ \ \mbox{scale}=\exp(\beta_0 + \beta_{1} rx_{1}) $$ 
The \texttt{dweibull} function has also been passed $t_1$ as the dependent variable as this distribution is only concerned with the observations that had a tumor appearance. The scale parameter $\beta_0$ is also only altered by the treatment indicator when the rats did not die prior to the appearance of a tumor. The negative sum is taken with the same reasoning as above. This likelihood is defined in the $R$ code in line 12.

The sum of the two different likelihoods are then combined in line 14 to create a combined likelihood for both censored and uncensored observations.

The function \texttt{nll.weibull} has been optimised in order to obtain the maximum likelihood estimate of the parameter $\boldsymbol{\theta}$, using the built in \texttt{optim} function in $R$. The initial point has been obtained by plotting graphs of each of the parameters versus its variance. The plots have then been observed to seek the value where the variance appears to be lowest. The graphs are displayed below.
```{r,echo=FALSE,message=FALSE, fig.height=2.5}
rats<- read.table("http://people.bath.ac.uk/kai21/ASI/rats_data.txt")
nll.weibull <- function (theta) {
  #create subset of data since for the purposes of calculating the optimal theta since 
  #when status = 0, the survival function does not depend on theta. Need to optimise this 
  #function using optim.
  t1 <- rats[which(rats$status==1),,]$time
  rx1 <- rats[which(rats$status==1),,]$rx
  t0 <- rats[which(rats$status==0),,]$time
  rx0 <- rats[which(rats$status==0),,]$rx
  #compute the negative log likelihood
  k <- 1/exp(theta[3]) #shape 
  lambda <- exp(theta[1] + theta[2]*rx0) #scale with censoring
  loglik1 <- -sum(dweibull(t1, shape=1/exp(theta[3]), scale=exp(theta[1] + theta[2]*rx1), log=TRUE))
  loglik2 <- sum((t0/lambda)^k)
  loglik <- loglik1 + loglik2
  loglik
}
theta <- c(0,0,0)
beta0 <- theta[1]
beta1 <- theta[2]
logsig <- theta[3]
beta0var <- 0
beta1var <- 0
logsigvar <- 0

par(mfrow=c(1,3))
for (i in 0:1000) {
  theta[1] <- 4.5 + i*0.0025
  beta0[i+1] <- theta[1]
  beta0var[i+1] <- nll.weibull(theta)
}

plot(beta0, beta0var, type="l", xlab=expression(beta[0]), ylab="Variance") 

theta <- c(0,0,0)
for (i in 0:1000) {
  theta[2] <- 4 + i*0.0025
  beta1[i+1] <- theta[2]
  beta1var[i+1] <- nll.weibull(theta)
}

plot(beta1, beta1var, type="l", xlab=expression(beta[1]), ylab="Variance") #estimate optimal beta1 to be ~5.25


theta <- c(0,0,0)
for (i in 0:1000) {
  theta[3] <- 1.5 + i*0.005
  logsig[i+1] <- theta[3]
  logsigvar[i+1] <- nll.weibull(theta)
}

plot(logsig, logsigvar, type="l", xlab=expression(log(sigma)), ylab="Variance") #estimate optimal logsigma to be ~2.75


```

The minimum variance for each of the parameters appears to be at approximately $\boldsymbol{\theta}= (5.75,5.25,2.75)$ and hence this will be taken as the initial point to proceed with the optimization.

The \texttt{optim} function works in such a way that seeks to optimize the given parameters using the given funtion which it will minimize by default. Since the \texttt{nll.weibull} function has been negated, \texttt{optim} will return the maximum likelihood estimate. The \texttt{optim} has been instructed to use the Nelder-Mead optimization method, The optimisation can be seen in the $R$ code below.

```{#numCode .R .numberLines}
theta <- c(5.75,5.25,2.75)
ratlik <- optim(theta, nll.weibull, hessian=TRUE, method="Nelder-Mead")
```



The returned, optimized vector of parameters $\boldsymbol{\hat{\theta}}$, the returned maximum value for the function and the convergence is seen as below.

```{r,echo=FALSE,message=FALSE}
theta <- c(5.75,5.25,2.75)
ratlik <- optim(theta, nll.weibull, hessian=TRUE, method="Nelder-Mead")
weibullapprox <- ratlik$par

#then to find the standard error, take the sqrt of the diag of the inverse hessian
hess <- solve(ratlik$hessian)
stderr <- sqrt(diag(hess))

#95% CI = parameter estimate +- ~1.96*stderr
CI <- c(ratlik$par[2]+qnorm(0.025)*stderr[2], ratlik$par[2]+qnorm(0.975)*stderr[2])
weibullapprox
ratlik$value
ratlik$convergence

```




The data is then analysed in such a way that the probability model takes on a log-logistic distribution as seen below. With the same shape and scale parameters as in the Weibull model.

$$ T_i \sim \mbox{log-logistic}(\mbox{shape} = \frac{1}{\sigma}, \mbox{scale} = \exp(\eta_i)),\  \ \ \ \ \  \ \  \eta_i = \beta_0 + \beta_1 x_i $$

Whilst the survival function of a log-logistic distribution can be expressed as.

$$ S(t|\mbox{a,b}) = \exp\bigg(- \log\bigg( 1 + \bigg(\frac{t}{b}\bigg)^a\bigg)\bigg), \  \ \ \ \ \ \ t > 0$$
* explanation of where survival function fits into it*

Following on from this, the Weibull distribution was again considered, but with added random effect $b$ taken into consideration. So we can now see the scale of the Weibull distribution is then altered to the exponent of $\eta_i$. Where $\eta_i$ is now as follows:
$$ \eta_i = \beta_0 + \beta_1 x_i + b_{litter(i)} $$

###analysis of data 
* Talk about weibull, loglik and weibull w random effects  
* explain how random effects aletered the weibull distribution  
* talk about how functions were initialised in r  
* explain how the starting points were chosen  
* talk about confidence intervals and how they were computed.  



### Results

* what came out of the analysis



###conclusions and recommendations

* Give the main results and conclusions.  
* Try to report your conclusion in context of the experiment from which the data came. 
* internal and external validity 
* only 40 of the rats actually had cancer. bigger sample size plz.   
* out of the 40 w tumor 21 received treatment?? lol  


#### Internal/External Validity (within the conclusion)

It can be seen from the data that for each litter, one in three of the rats were given the treatment, whilst the other two received only the control. Hence, fifty of the rats in total received treatment.
60 of the rats died at week 104 this shows threat to external validity. y they all die???
  
### Appendices

Maybe not??????
  
